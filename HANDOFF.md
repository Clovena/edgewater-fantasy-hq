# HANDOFF.md - AI Agent Knowledge Transfer

## Project Overview

**Edgewater Fantasy Network** is a multi-league fantasy football management system supporting three leagues:
- **Epsilon Fantasy** - Standard league
- **Sixth City Dynasty** - Dynasty league (primary development focus)
- **Survivor** - Survivor-style league

The project provides:
- Weekly power rankings with print-optimized layouts
- Interactive data visualizations (standings, record books)
- Team color/branding management
- Manager directory (cross-league)
- API data integration via R scripts using `ffscrapr` package

## Technology Stack

### Frontend
- **HTML5** - Semantic markup, template-based navigation
- **CSS3** - Custom properties, print media queries, responsive design
- **Vanilla JavaScript** - No frameworks, module-based organization
- **External Libraries**: 
  - `js-yaml 4.1.0` (YAML parsing)
  - Google Fonts (Lato, Bungee, Knewave, Rubik Dirt)
  - Material Symbols (icons)

### Backend/Data
- **R** - Data pipeline using `ffscrapr`, `jsonlite`, `dplyr`
- **Sleeper API** - Fantasy platform data source
- **CSV** - Structured API data storage
- **JSON** - Reference data (metadata, configurations)
- **YAML** - Weekly content (power rankings)

## Directory Structure

```
/
├── index.html                  # Homepage
├── weekly-hub.html             # Weekly power rankings hub
├── assets/
│   ├── fonts/                  # Custom team fonts (if needed)
│   ├── icons/
│   └── images/
├── css/
│   ├── global.css              # Base styles, CSS variables
│   ├── weekly-hub.css          # Print-optimized weekly rankings
│   ├── epsilon.css             # Epsilon-specific theme
│   ├── sixth-city.css          # Sixth City-specific theme
│   └── survivor.css            # Survivor-specific theme
├── data/
│   └── {league-name}/
│       ├── api/                # Scraped CSV data from ffscrapr
│       │   ├── fact_franchises.csv     # Team metadata with colors
│       │   ├── standings.csv           # Multi-season standings
│       │   └── *.csv                   # Other API data
│       ├── ref/                # Reference data (manual/config)
│       │   ├── team_metadata.json      # Franchise branding (franchise_id keyed)
│       │   ├── league_config.json      # Season/league_id mapping for scrapers
│       │   ├── playoff_seeds.json      # Historical playoff seeding
│       │   └── draft_slots.json        # Draft position tracking
│       └── content/            # Weekly editorial content
│           └── week{NN}.yml    # Power rankings (YAML format)
├── pages/
│   └── {league-name}/
│       ├── index.html          # League homepage
│       ├── record-book.html    # Interactive standings table
│       └── colors.html         # Team color viewer
├── scripts/
│   ├── js/
│   │   ├── navigation.js       # Template loading, hamburger menu
│   │   ├── weekly-hub.js       # YAML loading, dynamic rendering
│   │   ├── record-book.js      # CSV loading, filtering, sorting
│   │   ├── colors.js           # Color display page logic
│   │   └── data-loader.js      # Shared data utilities
│   └── r/
│       ├── utils.R             # upsert_data() and shared functions
│       ├── team_metadata.R     # Team metadata query functions
│       └── models/
│           └── sixth-city/
│               ├── sixth_city_scraper.R   # Main data pipeline
│               ├── fact_draft.R           # Draft data modeling
│               └── fact_franchises.R      # Franchise fact table
└── templates/
    ├── header.html             # Top bar with hamburger
    ├── bottom-nav.html         # Bottom navigation
    ├── epsilon-menu.html       # Epsilon hamburger menu
    ├── sixth-city-menu.html    # Sixth City hamburger menu
    ├── survivor-menu.html      # Survivor hamburger menu
    └── weekly-menu.html        # Weekly hub hamburger menu
```

## Data Architecture

### Data Flow
1. **R Scrapers** → Pull from Sleeper API via `ffscrapr` → Write to `/data/{league}/api/*.csv`
2. **JSON/YAML** → Manually curated content in `/data/{league}/ref/` and `/content/`
3. **Frontend** → Loads CSVs/JSON/YAML → Renders dynamic pages

### Data Categories

#### `/api/` - API-Scraped Data (CSV)
- Generated by R scripts
- Consolidated multi-season data with `season` column
- Upsert pattern: delete matching keys + insert new rows
- **Key files:**
  - `fact_franchises.csv` - Most recent franchise data per season (primary/secondary/tertiary colors, owner, abbreviation)
  - `standings.csv` - H2H records, points, all seasons
  - `schedule.csv` - Matchups by week/season

#### `/ref/` - Reference Data (JSON)
- Manually maintained or semi-automated
- Configuration and metadata
- **Key files:**
  - `team_metadata.json` - Franchise branding with historical name tracking (franchise_id-keyed, optional `history` arrays with `seasons` arrays)
  - `league_config.json` - Array of `{season, league_id, platform}` objects for R scrapers
  - `playoff_seeds.json` - Season-keyed objects with arrays of `{seed, franchise_id}`

#### `/content/` - Weekly Content (YAML)
- Power rankings and editorial content
- **Structure:**
  ```yaml
  intro:
    title: "Week 1 Power Rankings"
    subtitle: "Week 1 • 2025 Season"
    description: "Week intro text..."
  ranks:
    - "Team Name 1"
    - "Team Name 2"
    # ... 14 teams
  blurbs:
    - "Analysis for Team 1..."
    - "Analysis for Team 2..."
    # ... matching number
  ```

## Key Patterns & Conventions

### League Name Consistency
**CRITICAL**: League names must be consistent across the codebase:
- Directory names: `sixth-city`, `epsilon`, `survivor` (kebab-case)
- JavaScript keys: `'sixth-city'` for API calls and metadata lookups
- **Common bug**: Mixing `'sixthCity'` (camelCase) and `'sixth-city'` causes metadata lookup failures

### CSV Parsing
Always use the `parseCSVLine()` function for CSVs with quoted values:
```javascript
function parseCSVLine(line) {
  // Handles quoted values with commas inside
  // Returns array of trimmed values
}
```

### Team Metadata Lookups
- `fact_franchises.csv` contains **most recent season data** for each franchise
- JavaScript creates name-based lookup: `teamMetadata[league][franchiseName]`
- `team_metadata.json` is franchise_id-keyed with optional `history` arrays

### R Upsert Pattern
```r
# From utils.R
upsert_data(file_path, new_data, key_cols)
# 1. Read existing CSV
# 2. anti_join to remove rows matching key_cols
# 3. bind_rows to add new data
# 4. write.csv to persist
```

### Historical Franchise Names
```json
{
  "7": {
    "franchise_name": "Prince Edward Islanders",
    "abbrev": "PEI",
    "history": [
      {
        "seasons": [2021, 2022, 2023, 2024],
        "franchise_name": "Pokemon Omega Judge Judy",
        "abbrev": "PKO"
      }
    ]
  }
}
```
Use `seasons` array with `.includes()` for multi-year spans.

## R Scripting Patterns

### Sourcing Files
```r
source("scripts/r/utils.R")  # Always source from project root
```

### Dynamic Function Calls
```r
func_name <- "ff_standings"
data <- get(func_name)(conn, season = 2025)
```

### Conditional Mutations
```r
# Call function first
draft_data <- ff_draft(conn)

# THEN conditionally mutate
if (func_name != "ff_draftpicks") {
  draft_data <- draft_data %>% mutate(season = season)
}
```

### Zero-Padding
```r
mutate(round_padded = sprintf("%02d", round))  # "01", "05", "13"
```

### String as Filter Expression
```r
library(rlang)
filter_expr <- parse_expr("season == 2022")
df %>% filter(!!filter_expr)
```

### Row Numbering by Group
```r
df %>%
  group_by(season) %>%
  mutate(overall = row_number()) %>%
  ungroup()
```

## JavaScript Patterns

### Template Loading
```javascript
// navigation.js handles all template loading
// Templates: header.html, bottom-nav.html, {league}-menu.html
// Automatically injects based on page context
```

### League Context Detection
```javascript
function detectPageContext(path) {
  if (path.includes('/sixth-city/')) return 'sixth-city';
  // ... other leagues
}
```

### CSV Loading with Color Application
```javascript
// weekly-hub.js pattern
const response = await fetch('/data/sixth-city/api/fact_franchises.csv');
const csvText = await response.text();
const lines = csvText.trim().split('\n');
const headers = parseCSVLine(lines[0]);
// Parse rows, get most recent season per franchise
// Apply primary color: header.style.backgroundColor = team.primary;
```

### Multi-Select Filtering
```javascript
// record-book.js pattern
const selectedSeasons = new Set();
// Aggregate data across selected seasons
// Use aggregateStandings() to sum wins/losses/points
```

### Sortable Tables
```javascript
// Add data-sort="column-name" to <th>
// Use setupTableSorting() to handle clicks
// Toggle sort direction with .sorted and .sort-asc/.sort-desc classes
```

## CSS Architecture

### CSS Custom Properties
Define in `:root` of `global.css`:
```css
--blue: #22283a;
--gold: #ffd700;
--font-sixth-city: 'Bungee', sans-serif;
--spacing-md: 1rem;
```

### League-Specific Theming
Apply theme class to `<body>`:
```html
<body class="sixth-city-theme">
```

### Print Optimization
```css
@page {
  size: 8.5in 11in;
  margin: 0;
}

@media print {
  .print-page {
    page-break-after: always;
  }
}
```

### Sticky Headers
```css
.data-table thead th {
  position: sticky;
  top: 0;
  z-index: 10;
  background-color: var(--blue);
}
```

## Common Workflows

### Adding a New Week of Power Rankings
1. Create `/data/{league}/content/week{NN}.yml`
2. Follow YAML structure with intro, ranks (14 teams), blurbs (14 items)
3. Use exact franchise names from `fact_franchises.csv`
4. Colors apply automatically from most recent season data

### Running R Scraper
```r
# From RStudio or terminal
source("scripts/r/models/sixth-city/sixth_city_scraper.R")
# Reads league_config.json
# Iterates all seasons
# Writes/updates CSVs in /data/sixth-city/api/
```

### Adding a New Page
1. Create HTML in `/pages/{league}/page-name.html`
2. Include league theme class on `<body>`
3. Add script references to `navigation.js` and page-specific JS
4. Create corresponding JS in `/scripts/js/page-name.js`
5. Add styles to `/css/{league}.css` if needed
6. Update menu template in `/templates/{league}-menu.html`

### Refactoring Directory Structure
**Example: Moving `/content/` to `/ref/`**
1. Update file paths in R scripts (`paste0()` calls)
2. Update fetch URLs in JavaScript (`fetch('/data/{league}/ref/...')`)
3. Update documentation/comments
4. Test all pages that load affected files

## Known Patterns to Watch

### League Key Mismatches
Always use `'sixth-city'` not `'sixthCity'` when calling `renderLeaguePage()`.

### CSV Quote Handling
Use `parseCSVLine()` for CSVs with quoted values, not simple `.split(',')`.

### Empty String Checks
Check for both null and empty: `if (value && value.trim() !== '')`

### R Terminal Execution
Use terminal for production runs, not RStudio's run button:
```bash
Rscript scripts/r/models/sixth-city/sixth_city_scraper.R
```

### VS Code R Diagnostics
Lintr errors in VS Code don't mean script is broken - verify by running in terminal.

## Git Workflow

### .gitignore
- R artifacts: `.Rhistory`, `.RData`, `.Renviron`
- Custom fonts: `/assets/fonts/` (if using custom team fonts)

### Commit Patterns
- Regular commits after completing discrete features
- Push frequently (`git push` after each session)
- Small, focused changes preferred over large monolithic commits

## Current State (December 2025)

### Production-Ready
- ✅ Sixth City data pipeline (R scraper)
- ✅ Record Book page with filtering/sorting
- ✅ Weekly Hub with dynamic color loading
- ✅ Team Colors page
- ✅ Navigation system with templates

### In Progress / TODO
- ⏳ Epsilon and Survivor scrapers (duplicate 6C pattern)
- ⏳ Weekly Hub content for Epsilon/Survivor
- ⏳ Manager Directory page
- ⏳ Populate playoff_seeds.json with real data
- ⏳ Additional Record Book features (playoff stats, championships)

## Troubleshooting Quick Reference

| Issue | Solution |
|-------|----------|
| Colors not applying | Check league key consistency ('sixth-city' vs 'sixthCity') |
| CSV parse errors | Use `parseCSVLine()` for quoted values |
| R script runs but no output | Check file paths start from project root |
| Font icons showing as text | Add Material Symbols `<link>` to HTML `<head>` |
| Sticky headers not working | Ensure `position: sticky`, `top: 0`, `z-index: 10` |
| Metadata lookup fails | Verify franchise names match exactly between YAML and CSV |

## Contact & Context

This project is owned by **zjricker** and represents a personal fantasy football management system with a focus on dynasty league (Sixth City) tracking. The codebase emphasizes:
- Clean separation of concerns (API/ref/content)
- Print-optimized layouts for sharing with league members
- Dynamic data visualization without frameworks
- Self-hosted solution with no external dependencies beyond API scraping

For questions or clarification, refer to git history and commit messages for context on architectural decisions.
